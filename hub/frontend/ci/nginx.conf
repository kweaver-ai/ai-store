server {
    listen       80;
    listen       [::]:80;

    # 隐藏版本号
    server_tokens off;

    # 启用错误日志和访问日志
    error_log /var/log/nginx/error.log warn;
    access_log /var/log/nginx/access.log;

    root /app/dist;
    index index.html;

    # 客户端最大上传文件大小
    client_max_body_size 20m;

    # Gzip 压缩配置
    gzip on;
    gzip_vary on;
    gzip_min_length 512;
    gzip_proxied expired no-cache no-store private auth;
    gzip_comp_level 4;
    gzip_types
        text/css
        text/javascript
        text/xml
        text/plain
        text/x-component
        application/javascript
        application/x-javascript
        application/json
        application/xml
        application/rss+xml
        application/atom+xml
        font/truetype
        font/opentype
        application/vnd.ms-fontobject
        image/svg+xml;

    # 根路径重定向到 /dip-hub/
    location = / {
        return 301 /dip-hub/;
    }

    # 将 /dip-hub 重定向到 /dip-hub/（确保路径一致性）
    location = /dip-hub {
       return 301 https://$host/dip-hub/;
    }
    
    # 主应用入口匹配
    location = /dip-hub/ {
        root /app/dist;
        try_files /index.html /index.html;
    }

    # 静态资源匹配
    location ~ ^/dip-hub/.*\.(js|css|jpg|jpeg|gif|png|ico|cur|gz|svg|svgz|mp4|ogg|ogv|webm|xlsx|woff|woff2|eot|ttf|otf|pdf|json)$ {
        root /app/dist;
        rewrite ^/dip-hub/(.*)$ /$1 break;
        add_header X-Frame-Options sameorigin always;
        
        # 静态资源缓存 30 天（JSON 除外）
        if ($request_filename ~* ^.*[.](js|css|png|jpg|jpeg|gif|svg|ico|woff|woff2|eot|ttf|otf|pdf)$) {
            add_header Cache-Control "public, max-age=2592000";
        }
        
        # JSON 文件不缓存
        if ($request_filename ~* ^.*[.](json)$) {
            add_header Cache-Control "no-cache";
        }
    }

    # React Router history 模式支持（匹配所有 /dip-hub/* 的请求，但不包括 /dip-hub/）
    location ~ ^/dip-hub/(.+)$ {
        root /app/dist;
        try_files /$1 /$1/ /index.html;
        
        # HTML 文件不缓存
        if ($request_filename ~* ^.*[.](html|htm)$) {
            expires 0;
            add_header Cache-Control "no-store";
        }
    }

    # K8s 健康检查端点
    location = /probe {
        access_log off;
        error_log  /dev/null;
        return 200 "ok";
        add_header Content-Type text/plain;
    }

    # 健康检查端点（兼容）
    location = /health/alive {
        access_log off;
        error_log  /dev/null;
        return 200 "alive";
        add_header Content-Type text/plain;
    }

    location = /health/ready {
        access_log off;
        error_log  /dev/null;
        return 200 "ready";
        add_header Content-Type text/plain;
    }

    # 错误页面
    error_page   500 502 503 504  /50x.html;
    location = /50x.html {
        root   /usr/share/nginx/html;
    }
}

