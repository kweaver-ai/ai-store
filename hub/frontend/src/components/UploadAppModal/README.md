# 组件介绍

这是一个上传应用安装包的弹窗组件 UploadAppModal，用于上传和安装应用。组件支持点击上传和拖拽上传两种方式，包含完整的文件验证、上传进度、错误处理和成功提示功能。

组件根据上传状态动态展示不同的 UI：

- **初始状态**：上传/拖拽区域
- **已选择文件**：文件信息展示、操作按钮
- **上传中**：上传进度提示
- **上传失败**：错误信息展示
- **上传成功**：成功提示

## 组件结构

```
UploadAppModal/
├── types.ts              # 类型声明、枚举定义（UploadStatus、FileInfo）
├── index.tsx             # 主组件（弹窗容器、上传逻辑）
├── utils.ts              # 工具方法（文件验证、格式化等）
└── index.module.less     # 样式文件（上传容器样式）
```

# 交互设计

## Figma 设计稿

- **整体布局**: `https://www.figma.com/design/awdYlPYcJPhGxTgSGCiUwm/%E5%95%86%E5%BA%97?node-id=557-1444&t=9dGmzwmPEPGpCs3L-4`
- **添加文件后**: `https://www.figma.com/design/awdYlPYcJPhGxTgSGCiUwm/%E5%95%86%E5%BA%97?node-id=557-1799&t=9dGmzwmPEPGpCs3L-4`
- **上传中**: `https://www.figma.com/design/awdYlPYcJPhGxTgSGCiUwm/%E5%95%86%E5%BA%97?node-id=557-2541&t=9dGmzwmPEPGpCs3L-4`
- **失败后**: `https://www.figma.com/design/awdYlPYcJPhGxTgSGCiUwm/%E5%95%86%E5%BA%97?node-id=557-2163&t=9dGmzwmPEPGpCs3L-4`
- **成功后**: `https://www.figma.com/design/awdYlPYcJPhGxTgSGCiUwm/%E5%95%86%E5%BA%97?node-id=557-2903&t=9dGmzwmPEPGpCs3L-4`
- **二次提示**: `https://www.figma.com/design/awdYlPYcJPhGxTgSGCiUwm/%E5%95%86%E5%BA%97?node-id=475-333&t=9dGmzwmPEPGpCs3L-4`

## 布局结构

- **整体布局**：使用 Ant Design Modal 组件，上下布局

  - **顶部**：弹窗头部（标题：安装应用包）
  - **中间内容区**：根据上传状态动态展示
    - **操作过程中**：
      - 上传/拖拽区域（Dragger 组件）
      - 文件信息展示区域（文件名称、大小、状态标签）
      - 错误信息展示区域（失败时显示）
      - 操作按钮区域（安装应用按钮）
    - **成功后**：
      - 成功提示区域（成功图标、提示文字）
  - **底部**：弹窗底部按钮区域
    - 成功状态：显示"确定"按钮
    - 其他状态：显示"取消"按钮

- **关键尺寸**：
  - 弹窗宽度：`620px`
  - 弹窗高度：`436px - 600px`（动态，最小 436px，最大 600px）
  - 内容区使用 `ScrollBarContainer` 支持滚动

## 交互行为

### 上传状态流程

1. **初始状态（INITIAL）**：

   - 显示上传/拖拽区域
   - 显示"安装应用"按钮（禁用状态）
   - 底部显示"取消"按钮

2. **已选择文件（READY）**：

   - 显示上传/拖拽区域（禁用状态）
   - 显示文件信息区域（文件名、大小、状态标签"等待安装"）
   - 显示"安装应用"按钮（可用状态）
   - 底部显示"取消"按钮

3. **上传中（UPLOADING）**：

   - 上传/拖拽区域显示加载动画和"正在验证应用包..."提示
   - 显示文件信息区域（状态标签"验证中"）
   - 显示"安装应用"按钮（禁用状态，透明度 0.25）
   - 底部显示"取消"按钮
   - 点击取消或关闭弹窗时，弹出二次确认对话框

4. **上传失败（FAILED）**：

   - 显示上传/拖拽区域（可用状态，可重新选择文件）
   - 显示文件信息区域（状态标签"安装失败"，红色样式）
   - 显示错误信息区域（红色背景，显示错误消息）
   - 显示"安装应用"按钮（可用状态，可重试）
   - 底部显示"取消"按钮

5. **上传成功（SUCCESS）**：
   - 隐藏所有操作区域
   - 显示成功提示区域（成功图标、提示文字）
   - 底部显示"确定"按钮（点击后调用 `onSuccess` 回调）

### 文件操作

- **文件选择**：

  - 支持点击上传区域选择文件
  - 支持拖拽文件到上传区域
  - 仅支持 `.dip` 格式文件
  - 文件大小限制：1GB

- **文件验证**：

  - 选择文件后立即验证格式和大小
  - 格式错误：显示错误提示"仅支持 .dip 格式的应用安装包"
  - 大小超限：显示错误提示"文件大小不能超过 1GB"
  - 验证通过后显示文件信息

- **取消操作**：
  - 非上传中：直接关闭弹窗
  - 上传中：弹出二次确认对话框"确认取消安装"，确认后取消上传请求并关闭弹窗

### 上传流程

- 点击"安装应用"按钮触发上传
- 使用 `AbortController` 支持取消上传
- 上传过程中禁用文件选择和操作按钮
- 上传成功或失败后更新 UI 状态

# 代码实现

## Props 接口

```typescript
interface UploadAppModalProps extends Pick<ModalProps, 'open' | 'onCancel'> {
  /** 上传成功的回调 */
  onSuccess: () => void
}
```

## 默认行为

- 弹窗打开时，重置所有状态为初始状态（`UploadStatus.INITIAL`）
- 弹窗关闭时，自动重置状态并取消正在进行的上传请求
- 默认禁用"安装应用"按钮，选择文件后启用

## 数据加载

- **文件上传**：点击"安装应用"按钮后，调用 `postApplications` 接口上传文件
- **接口位置**：`/src/apis/dip-hub/applications.ts`
- **上传方式**：将文件转换为 Blob，使用 `application/octet-stream` Content-Type 上传
- **取消上传**：使用 `AbortController` 实现上传请求的取消

## 文件验证

- **格式验证**：使用 `validateFileFormat` 函数，检查文件扩展名是否为 `.dip`
- **大小验证**：使用 `validateFileSize` 函数，检查文件大小是否超过 1GB（1024 _ 1024 _ 1024 bytes）
- **验证时机**：文件选择后立即验证，验证失败显示错误提示，不更新状态

## 样式规范

- **主要使用 Tailwind CSS** 完成样式
- **CSS Modules**：使用 `index.module.less` 处理上传容器的特殊样式
- **关键样式值**：

  - 弹窗宽度：`620px`
  - 文件信息区域背景：`#F9FAFC`
  - 错误信息区域背景：`#FFF1F0`，边框：`#FFCCC7`
  - 成功图标颜色：`--dip-success-color`
  - 失败状态颜色：`--dip-error-color`

- **状态标签样式**：
  - 等待安装：默认边框样式
  - 验证中：默认边框样式
  - 安装失败：红色文字、浅红色背景、红色边框

## 性能优化

- 使用 `useRef` 存储 `AbortController`，避免不必要的重渲染
- 使用 `useEffect` 在弹窗关闭时清理状态和取消请求
- 文件信息使用 `useMemo` 缓存计算结果

## 注意事项

1. **文件格式限制**：仅支持 `.dip` 格式文件，其他格式会被拒绝并显示错误提示
2. **文件大小限制**：文件大小不能超过 1GB，超过限制会被拒绝并显示错误提示
3. **上传取消**：上传过程中点击取消会弹出二次确认，确认后使用 `AbortController` 取消请求
4. **状态重置**：弹窗关闭时自动重置所有状态，包括文件信息、错误信息、上传状态
5. **错误处理**：上传失败时，优先显示接口返回的 `error.description`，如果没有则显示默认错误消息
6. **成功回调**：上传成功后，点击"确定"按钮会调用 `onSuccess` 回调，通常用于刷新应用列表
7. **文件选择限制**：上传中或成功后，禁用文件选择功能，防止重复操作
8. **滚动处理**：内容区域使用 `ScrollBarContainer` 组件，支持自定义滚动条样式
