import type { ModalProps } from 'antd'
import { Form, Input, Modal, message } from 'antd'
import { useEffect, useState } from 'react'
import {
  type CreateNodeParams,
  type ObjectType,
  type ProjectInfo,
  postApplicationNode,
  postFunctionNode,
  postPageNode,
  postProjects,
  putApplicationNode,
  putFunctionNode,
  putPageNode,
  putProjects,
} from '@/apis'
import {
  objectDescPlaceholderMap,
  objectNamePlaceholderMap,
  objectTypeNameMap,
} from '@/pages/ProjectManagement/utils'

export interface ActionModalProps extends Pick<ModalProps, 'open' | 'onCancel'> {
  /** 新建成功的回调，传递信息 */
  onSuccess: (result: any) => void

  /** 要编辑的对象信息 */
  objectInfo?: {
    id: string
    name: string
    description: string
  }

  /** 操作类型 */
  operationType: 'add' | 'edit'

  /** 操作对象类型 */
  objectType: ObjectType

  /** 项目 ID（新建节点时需要） */
  projectId?: string

  /** 父节点 ID（新建子节点时需要） */
  parentId?: string | null

  /** 项目信息 */
  projectInfo?: ProjectInfo
}

/** 新建 编辑 弹窗 */
const ActionModal = ({
  open,
  onCancel,
  onSuccess,
  objectInfo,
  operationType,
  objectType,
  projectId,
  parentId,
  projectInfo,
}: ActionModalProps) => {
  const [form] = Form.useForm()
  const [loading, setLoading] = useState(false)
  const [messageApi, contextHolder] = message.useMessage()

  // 使用 Form.useWatch 监听 name 字段变化
  const nameValue = Form.useWatch('name', form)
  const canSubmit = !!nameValue

  // 当弹窗关闭时重置表单
  useEffect(() => {
    if (open) {
      form.resetFields()
      setLoading(false)
    }
    if (operationType === 'add' && projectInfo && objectType === 'application') {
      form.setFieldsValue({
        name: projectInfo.name,
        description: projectInfo.description,
      })
    }
    if (operationType === 'edit' && objectInfo) {
      form.setFieldsValue(objectInfo)
    }
  }, [open, form, objectInfo, operationType, projectId, parentId])

  /** 处理确定按钮点击 */
  const handleOk = async () => {
    try {
      const values = await form.validateFields()
      const baseParams = {
        name: values.name?.trim(),
        description: values.description?.trim(),
      }
      const params: CreateNodeParams = {
        ...baseParams,
        project_id: projectId || '',
        parent_id: parentId || '',
      }
      setLoading(true)
      let result: any
      // TODO: 调用 API 创建/编辑节点
      if (objectType === 'project') {
        if (operationType === 'add') {
          // result = await postProjects(baseParams)
          result = {
            id: `project_${Math.random().toString(36).substring(2, 15)}`,
            name: values.name,
            description: values.description,
            type: objectType,
            parent_id: parentId || null,
            creator: '123',
            created_at: new Date().toISOString(),
            editor: '123',
            edited_at: new Date().toISOString(),
          }
        } else if (operationType === 'edit' && objectInfo) {
          result = await putProjects(objectInfo.id, baseParams)
        }
      } else if (objectType === 'application') {
        if (operationType === 'add') {
          // result = await postApplicationNode(params)
          result = {
            id: `app_${Math.random().toString(36).substring(2, 15)}`,
            name: values.name,
            type: objectType,
            parent_id: parentId || null,
            description: values.description,
            creator: '123',
            created_at: new Date().toISOString(),
            editor: '123',
            edited_at: new Date().toISOString(),
          }
        } else if (operationType === 'edit' && objectInfo) {
          // result = await putApplicationNode(objectInfo.id, params)
          result = {
            id: objectInfo.id,
            name: values.name,
            type: objectType,
            parent_id: parentId || null,
            description: values.description,
            creator: '123',
            created_at: new Date().toISOString(),
            editor: '123',
            edited_at: new Date().toISOString(),
          }
        }
      } else if (objectType === 'page') {
        if (operationType === 'add') {
          // result = await postPageNode(params)
          result = {
            id: `page_${Math.random().toString(36).substring(2, 15)}`,
            name: values.name,
            type: objectType,
            parent_id: parentId || null,
            description: values.description,
            creator: '123',
            created_at: new Date().toISOString(),
            editor: '123',
            edited_at: new Date().toISOString(),
          }
        } else if (operationType === 'edit' && objectInfo) {
          // result = await putPageNode(objectInfo.id, params)
          result = {
            id: objectInfo.id,
            name: values.name,
            type: objectType,
            parent_id: parentId || null,
            description: values.description,
            creator: '123',
            created_at: new Date().toISOString(),
            editor: '123',
            edited_at: new Date().toISOString(),
          }
        }
      } else if (objectType === 'function') {
        if (operationType === 'add') {
          // result = await postFunctionNode(params)
          result = {
            id: `func_${Math.random().toString(36).substring(2, 15)}`,
            name: values.name,
            type: objectType,
            parent_id: parentId || null,
            description: values.description,
            creator: '123',
            created_at: new Date().toISOString(),
            editor: '123',
            edited_at: new Date().toISOString(),
          }
        } else if (operationType === 'edit' && objectInfo) {
          // result = await putFunctionNode(objectInfo.id, params)
          result = {
            id: objectInfo.id,
            name: values.name,
            type: objectType,
            parent_id: parentId || null,
            description: values.description,
            creator: '123',
            created_at: new Date().toISOString(),
            editor: '123',
            edited_at: new Date().toISOString(),
          }
        }
      }
      messageApi.success(
        `${operationType === 'add' ? '新建' : '编辑'}${objectTypeNameMap(objectType)}成功`,
      )
      // 传递完整的节点信息（包含 id、name、description）
      onSuccess(result)
      onCancel?.(undefined as any)
    } catch (err: any) {
      // 表单验证失败时不显示错误消息
      if (err?.errorFields) {
        return
      }
      // API 请求失败时显示错误消息并停留
      if (err?.description) {
        messageApi.error(err.description)
      } else {
        messageApi.error(
          `${operationType === 'add' ? '新建' : '编辑'}${objectTypeNameMap(objectType)}失败，请稍后重试`,
        )
      }
    } finally {
      setLoading(false)
    }
  }

  return (
    <>
      {contextHolder}
      <Modal
        title={`${operationType === 'add' ? '新建' : '编辑'}${objectTypeNameMap(objectType)}`}
        open={open}
        onCancel={onCancel}
        onOk={handleOk}
        confirmLoading={loading}
        closable
        maskClosable={false}
        destroyOnHidden
        width={520}
        okText="确定"
        cancelText="取消"
        okButtonProps={{ loading: loading, disabled: !canSubmit }}
        footer={(_, { OkBtn, CancelBtn }) => (
          <>
            <OkBtn />
            <CancelBtn />
          </>
        )}
      >
        <Form form={form} layout="vertical" className="mt-4 mb-10">
          <Form.Item label="名称" name="name" rules={[{ required: true, message: '请输入名称' }]}>
            <Input placeholder={objectNamePlaceholderMap(objectType)} maxLength={128} showCount />
          </Form.Item>

          <Form.Item label="描述" name="description">
            <Input.TextArea
              placeholder={objectDescPlaceholderMap(objectType)}
              rows={4}
              maxLength={400}
              showCount
              autoSize={{ minRows: 5, maxRows: 5 }}
            />
          </Form.Item>
        </Form>
      </Modal>
    </>
  )
}

export default ActionModal
