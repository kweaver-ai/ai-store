# globalState.ts è¯¦ç»†è®²è§£

## ğŸ“¦ æ•°æ®å­˜å‚¨åœ¨å“ªé‡Œï¼Ÿ

**ç­”æ¡ˆï¼šå­˜å‚¨åœ¨æµè§ˆå™¨å†…å­˜ä¸­çš„ä¸€ä¸ª JavaScript å¯¹è±¡é‡Œ**

```typescript
// ç¬¬ 157-160 è¡Œï¼šåˆ›å»ºäº†ä¸€ä¸ªå…¨å±€å•ä¾‹å¯¹è±¡
const stateManager = new MicroAppStateManager({
  lang: 'zh-CN',
  breadcrumb: [],
})
```

### å­˜å‚¨ä½ç½®è¯¦è§£

1. **ç‰©ç†ä½ç½®**ï¼šæµè§ˆå™¨å†…å­˜ï¼ˆRAMï¼‰
2. **å­˜å‚¨æ–¹å¼**ï¼šJavaScript å¯¹è±¡ï¼ˆ`MicroAppStateManager` ç±»çš„å®ä¾‹ï¼‰
3. **ç”Ÿå‘½å‘¨æœŸ**ï¼šä»é¡µé¢åŠ è½½åˆ°é¡µé¢å…³é—­ï¼Œä¸€ç›´å­˜åœ¨
4. **ä½œç”¨åŸŸ**ï¼šæ•´ä¸ªä¸»åº”ç”¨ï¼ˆæ‰€æœ‰æ¨¡å—éƒ½å¯ä»¥è®¿é—®ï¼‰

**ç±»æ¯”ç†è§£**ï¼š

- å°±åƒä½ å®¶é‡Œçš„ä¸€ä¸ª**å…±äº«ç™½æ¿**ï¼Œæ‰€æœ‰äººéƒ½å¯ä»¥åœ¨ä¸Šé¢å†™ä¸œè¥¿ï¼Œæ‰€æœ‰äººéƒ½èƒ½çœ‹åˆ°
- åˆ·æ–°é¡µé¢ = æ¢äº†ä¸€å—æ–°ç™½æ¿ï¼ˆæ•°æ®ä¼šä¸¢å¤±ï¼‰
- å…³é—­æµè§ˆå™¨ = æ‰”æ‰ç™½æ¿

---

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### 1. æ ¸å¿ƒç±»ï¼š`MicroAppStateManager`

```typescript
class MicroAppStateManager {
  private state: MicroAppGlobalState // ğŸ‘ˆ è¿™å°±æ˜¯å­˜å‚¨æ•°æ®çš„å¯¹è±¡
  private listeners: Set<StateChangeListener> // ğŸ‘ˆ ç›‘å¬å™¨åˆ—è¡¨
  private currentListener: StateChangeListener | null // ğŸ‘ˆ å½“å‰æ¿€æ´»çš„ç›‘å¬å™¨
}
```

**ä¸¤ä¸ªæ ¸å¿ƒå±æ€§**ï¼š

- `state`ï¼šå®é™…å­˜å‚¨çš„æ•°æ®ï¼ˆä¸€ä¸ªæ™®é€šå¯¹è±¡ï¼‰
- `listeners`ï¼šæ‰€æœ‰æ³¨å†Œçš„ç›‘å¬å‡½æ•°ï¼ˆSet é›†åˆï¼Œæ”¯æŒå¤šä¸ªç›‘å¬å™¨åŒæ—¶å­˜åœ¨ï¼‰

### 2. æ•°æ®åˆå§‹åŒ–

```typescript
// ç¬¬ 157-160 è¡Œ
const stateManager = new MicroAppStateManager({
  lang: 'zh-CN', // é»˜è®¤è¯­è¨€
  breadcrumb: [], // é»˜è®¤é¢åŒ…å±‘ä¸ºç©º
})
```

**åˆå§‹çŠ¶æ€**ï¼š

```javascript
{
  lang: 'zh-CN',
  breadcrumb: []
}
```

---

## ğŸ”„ å·¥ä½œæµç¨‹

### åœºæ™¯ 1ï¼šä¸»åº”ç”¨æ›´æ–°çŠ¶æ€

```typescript
// åœ¨ MicroAppContainer ä¸­
setGlobalState(
  {
    microApp: {
      name: 'micro-app-two',
      displayName: 'å¾®åº”ç”¨äºŒ',
      routeBasename: '/app/micro-app-two',
    },
  },
  { allowAllFields: true } // ğŸ‘ˆ å…³é”®ï¼šå…è®¸æ›´æ–°æ‰€æœ‰å­—æ®µ
)
```

**æ‰§è¡Œæµç¨‹**ï¼š

1. è°ƒç”¨ `setGlobalState(patch, { allowAllFields: true })`
2. è¿›å…¥ `stateManager.setState(patch, options)`
3. å› ä¸º `allowAllFields: true`ï¼Œç›´æ¥åˆå¹¶åˆ° `this.state`
4. è°ƒç”¨ `notifyListeners()` é€šçŸ¥æ‰€æœ‰ç›‘å¬å™¨
5. æ‰€æœ‰ç›‘å¬å™¨æ”¶åˆ°æ–°çŠ¶æ€ï¼Œæ‰§è¡Œå›è°ƒå‡½æ•°

### åœºæ™¯ 2ï¼šå¾®åº”ç”¨æ›´æ–°çŠ¶æ€

```typescript
// åœ¨å¾®åº”ç”¨ä¸­ï¼ˆé€šè¿‡ propsï¼‰
props.setGlobalState({
  breadcrumb: [{ title: 'é¦–é¡µ', path: '/' }, { title: 'é¡µé¢äºŒ' }],
})
```

**æ‰§è¡Œæµç¨‹**ï¼š

1. å¾®åº”ç”¨è°ƒç”¨ `props.setGlobalState(patch)`ï¼ˆæ²¡æœ‰ `allowAllFields`ï¼‰
2. è¿›å…¥ `stateManager.setState(patch)`ï¼ˆé»˜è®¤ `allowAllFields: false`ï¼‰
3. **è¿‡æ»¤å­—æ®µ**ï¼šåªä¿ç•™ `allowedFields` ä¸­çš„å­—æ®µï¼ˆç›®å‰åªæœ‰ `breadcrumb`ï¼‰
4. å¦‚æœ `patch` ä¸­æœ‰ `lang`ã€`microApp` ç­‰å­—æ®µï¼Œä¼šè¢«**è¿‡æ»¤æ‰**ï¼ˆå®‰å…¨æœºåˆ¶ï¼‰
5. åªæ›´æ–° `breadcrumb` å­—æ®µ
6. é€šçŸ¥æ‰€æœ‰ç›‘å¬å™¨

**å®‰å…¨æœºåˆ¶**ï¼š

```typescript
// ç¬¬ 78-84 è¡Œï¼šå­—æ®µè¿‡æ»¤é€»è¾‘
const filteredPatch: Partial<MicroAppGlobalState> = {}
allowedFields.forEach((field) => {
  if (field in patch) {
    filteredPatch[field] = patch[field] // åªä¿ç•™å…è®¸çš„å­—æ®µ
  }
})
```

---

## ğŸ‘‚ ç›‘å¬æœºåˆ¶

### å¦‚ä½•ç›‘å¬çŠ¶æ€å˜åŒ–ï¼Ÿ

```typescript
// åœ¨ Header ç»„ä»¶ä¸­
useEffect(() => {
  const unsubscribe = onGlobalStateChange((state, prev) => {
    // state: æ–°çŠ¶æ€
    // prev: æ—§çŠ¶æ€
    if (state.breadcrumb) {
      setMicroAppBreadcrumb(state.breadcrumb)
    }
  }, true) // true = ç«‹å³æ‰§è¡Œä¸€æ¬¡

  return () => {
    unsubscribe() // ç»„ä»¶å¸è½½æ—¶å–æ¶ˆç›‘å¬
  }
}, [isMicroAppRoute])
```

### ç›‘å¬å™¨å·¥ä½œåŸç†

1. **æ³¨å†Œç›‘å¬å™¨**ï¼ˆç¬¬ 101-118 è¡Œï¼‰ï¼š

   ```typescript
   onGlobalStateChange(callback, fireImmediately) {
     // 1. ç›´æ¥æ·»åŠ ç›‘å¬å™¨ï¼ˆå…è®¸å¤šä¸ªç›‘å¬å™¨åŒæ—¶å­˜åœ¨ï¼‰
     this.listeners.add(callback)

     // 2. å¦‚æœ fireImmediately = trueï¼Œç«‹å³æ‰§è¡Œä¸€æ¬¡
     if (fireImmediately) {
       callback(this.getState(), this.getState())
     }

     // 3. è¿”å›å–æ¶ˆç›‘å¬çš„å‡½æ•°
     return () => {
       this.listeners.delete(callback)
     }
   }
   ```

2. **é€šçŸ¥ç›‘å¬å™¨**ï¼ˆç¬¬ 142-153 è¡Œï¼‰ï¼š

   ```typescript
   private notifyListeners(state, prev) {
     this.listeners.forEach((listener) => {
       try {
         listener(state, prev)  // æ‰§è¡Œå›è°ƒå‡½æ•°
       } catch (error) {
         console.error('Error in listener:', error)
       }
     })
   }
   ```

3. **è§¦å‘æ—¶æœº**ï¼šæ¯æ¬¡è°ƒç”¨ `setState()` æ—¶ï¼Œéƒ½ä¼šè°ƒç”¨ `notifyListeners()`

---

## ğŸ“Š æ•°æ®æµå‘å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   æµè§ˆå™¨å†…å­˜                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  stateManager (å•ä¾‹å¯¹è±¡)                          â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
â”‚  â”‚  â”‚ state: {                                 â”‚    â”‚   â”‚
â”‚  â”‚  â”‚   lang: 'zh-CN',                         â”‚    â”‚   â”‚
â”‚  â”‚  â”‚   breadcrumb: [...],                     â”‚    â”‚   â”‚
â”‚  â”‚  â”‚   microApp: {...}                        â”‚    â”‚   â”‚
â”‚  â”‚  â”‚ }                                        â”‚    â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
â”‚  â”‚  â”‚ listeners: Set<Function>                 â”‚    â”‚   â”‚
â”‚  â”‚  â”‚   - Header ç»„ä»¶çš„ç›‘å¬å‡½æ•°                 â”‚    â”‚   â”‚
â”‚  â”‚  â”‚   - å…¶ä»–ç»„ä»¶çš„ç›‘å¬å‡½æ•°                    â”‚    â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â–²                    â”‚                    â–²
         â”‚                    â”‚                    â”‚
   å†™å…¥æ•°æ®              è¯»å–æ•°æ®              ç›‘å¬å˜åŒ–
         â”‚                    â”‚                    â”‚
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
    â”‚         â”‚          â”‚         â”‚          â”‚         â”‚
ä¸»åº”ç”¨     å¾®åº”ç”¨      ä¸»åº”ç”¨     å¾®åº”ç”¨     ä¸»åº”ç”¨     å¾®åº”ç”¨
setState  setState    getState   getState  onChange  onChange
```

---

## ğŸ¯ å®é™…ä½¿ç”¨ç¤ºä¾‹

### ç¤ºä¾‹ 1ï¼šä¸»åº”ç”¨è®¾ç½®å¾®åº”ç”¨ä¿¡æ¯

```typescript
// src/pages/MicroAppContainer/index.tsx
setGlobalState(
  {
    microApp: {
      name: 'micro-app-two',
      displayName: 'å¾®åº”ç”¨äºŒ',
      routeBasename: '/app/micro-app-two',
    },
  },
  { allowAllFields: true } // ğŸ‘ˆ å¿…é¡»ä¼ ï¼Œå¦åˆ™ä¼šè¢«è¿‡æ»¤æ‰
)
```

**ç»“æœ**ï¼š`stateManager.state.microApp` è¢«æ›´æ–°

### ç¤ºä¾‹ 2ï¼šå¾®åº”ç”¨æ›´æ–°é¢åŒ…å±‘

```typescript
// å¾®åº”ç”¨å†…éƒ¨
props.setGlobalState({
  breadcrumb: [{ title: 'é¦–é¡µ', path: '/' }, { title: 'é¡µé¢äºŒ' }],
})
```

**ç»“æœ**ï¼š

- âœ… `stateManager.state.breadcrumb` è¢«æ›´æ–°
- âŒ å¦‚æœåŒæ—¶ä¼ äº† `lang: 'en-US'`ï¼Œä¼šè¢«è¿‡æ»¤æ‰ï¼ˆå¾®åº”ç”¨æ— æƒä¿®æ”¹ï¼‰

### ç¤ºä¾‹ 3ï¼šHeader ç›‘å¬é¢åŒ…å±‘å˜åŒ–

```typescript
// src/components/Header/index.tsx
const unsubscribe = onGlobalStateChange((state, prev) => {
  if (state.breadcrumb) {
    setMicroAppBreadcrumb(state.breadcrumb) // æ›´æ–° UI
  }
}, true)
```

**ç»“æœ**ï¼š

- é¢åŒ…å±‘å˜åŒ–æ—¶ï¼ŒHeader è‡ªåŠ¨æ›´æ–°æ˜¾ç¤º

---

## ğŸ”’ å®‰å…¨æœºåˆ¶

### å­—æ®µæƒé™æ§åˆ¶

```typescript
// ç¬¬ 2 è¡Œï¼šå®šä¹‰å…è®¸å¾®åº”ç”¨æ›´æ–°çš„å­—æ®µ
const allowedFields = ['breadcrumb']

// ç¬¬ 77-84 è¡Œï¼šè¿‡æ»¤é€»è¾‘
if (options?.allowAllFields) {
  // ä¸»åº”ç”¨ï¼šå…è®¸æ›´æ–°æ‰€æœ‰å­—æ®µ
  this.state = { ...this.state, ...patch }
} else {
  // å¾®åº”ç”¨ï¼šåªå…è®¸æ›´æ–° allowedFields ä¸­çš„å­—æ®µ
  const filteredPatch = {}
  allowedFields.forEach((field) => {
    if (field in patch) {
      filteredPatch[field] = patch[field]
    }
  })
  this.state = { ...this.state, ...filteredPatch }
}
```

**ä¸ºä»€ä¹ˆéœ€è¦è¿™ä¸ªæœºåˆ¶ï¼Ÿ**

- é˜²æ­¢å¾®åº”ç”¨ä¿®æ”¹æ•æ„Ÿä¿¡æ¯ï¼ˆå¦‚ `lang`ã€`microApp` ç­‰ï¼‰
- åªæœ‰ä¸»åº”ç”¨å¯ä»¥ä¿®æ”¹è¿™äº›å­—æ®µ
- å¾®åº”ç”¨åªèƒ½ä¿®æ”¹ `breadcrumb`

---

## ğŸ’¡ å…³é”®ç‚¹æ€»ç»“

1. **å­˜å‚¨ä½ç½®**ï¼šæµè§ˆå™¨å†…å­˜ä¸­çš„ JavaScript å¯¹è±¡
2. **å•ä¾‹æ¨¡å¼**ï¼šæ•´ä¸ªåº”ç”¨åªæœ‰ä¸€ä¸ª `stateManager` å®ä¾‹
3. **æƒé™æ§åˆ¶**ï¼šä¸»åº”ç”¨å¯ä»¥æ›´æ–°æ‰€æœ‰å­—æ®µï¼Œå¾®åº”ç”¨åªèƒ½æ›´æ–° `breadcrumb`
4. **ç›‘å¬æœºåˆ¶**ï¼šä½¿ç”¨è§‚å¯Ÿè€…æ¨¡å¼ï¼ŒçŠ¶æ€å˜åŒ–æ—¶é€šçŸ¥æ‰€æœ‰ç›‘å¬å™¨
5. **æ•°æ®æŒä¹…åŒ–**ï¼š**ä¸æŒä¹…åŒ–**ï¼Œåˆ·æ–°é¡µé¢ä¼šä¸¢å¤±ï¼ˆå¦‚æœéœ€è¦æŒä¹…åŒ–ï¼Œå¯ä»¥ç»“åˆ localStorageï¼‰

---

## ğŸ†š ä¸ qiankun globalState çš„åŒºåˆ«

| ç‰¹æ€§     | qiankun globalState | æˆ‘ä»¬çš„å®ç°              |
| -------- | ------------------- | ----------------------- |
| å­˜å‚¨ä½ç½® | æµè§ˆå™¨å†…å­˜          | æµè§ˆå™¨å†…å­˜              |
| ä¾èµ–     | qiankun æ¡†æ¶        | æ— ä¾èµ–ï¼ˆçº¯ JSï¼‰         |
| å…¼å®¹æ€§   | qiankun 3.0 å°†ç§»é™¤  | æ°¸ä¹…å¯ç”¨                |
| åŠŸèƒ½     | åŸºç¡€çŠ¶æ€ç®¡ç†        | åŸºç¡€çŠ¶æ€ç®¡ç† + æƒé™æ§åˆ¶ |

**ä¸ºä»€ä¹ˆè‡ªå·±å®ç°ï¼Ÿ**

- qiankun 3.0 ä¼šç§»é™¤ globalState
- æˆ‘ä»¬éœ€è¦æ›´ç²¾ç»†çš„æƒé™æ§åˆ¶
- ä¸ä¾èµ–ç¬¬ä¸‰æ–¹åº“ï¼Œæ›´å¯æ§

---

## ğŸ› è°ƒè¯•æŠ€å·§

### æŸ¥çœ‹å½“å‰çŠ¶æ€

```typescript
import { getGlobalState } from '@/utils/micro-app/globalState'

// åœ¨æµè§ˆå™¨æ§åˆ¶å°æˆ–ä»£ç ä¸­
console.log(getGlobalState())
// è¾“å‡ºï¼š
// {
//   lang: 'zh-CN',
//   breadcrumb: [...],
//   microApp: {...}
// }
```

### ç›‘å¬æ‰€æœ‰çŠ¶æ€å˜åŒ–

```typescript
onGlobalStateChange((state, prev) => {
  console.log('çŠ¶æ€å˜åŒ–ï¼š', {
    æ—§çŠ¶æ€: prev,
    æ–°çŠ¶æ€: state,
    å˜åŒ–å­—æ®µ: Object.keys(state).filter((key) => state[key] !== prev[key]),
  })
}, true)
```

---

## â“ å¸¸è§é—®é¢˜

### Q1: æ•°æ®ä¼šä¸¢å¤±å—ï¼Ÿ

**A**: ä¼šã€‚åˆ·æ–°é¡µé¢æˆ–å…³é—­æµè§ˆå™¨ï¼Œæ•°æ®ä¼šä¸¢å¤±ã€‚è¿™æ˜¯å†…å­˜å­˜å‚¨çš„ç‰¹æ€§ã€‚

### Q2: å¯ä»¥å¤šä¸ªåœ°æ–¹åŒæ—¶ç›‘å¬å—ï¼Ÿ

**A**: âœ… **å¯ä»¥ï¼** ç°åœ¨æ”¯æŒå¤šä¸ªç›‘å¬å™¨åŒæ—¶ç›‘å¬ï¼Œæ¯ä¸ªç›‘å¬å™¨ç‹¬ç«‹ç®¡ç†ï¼Œäº’ä¸å½±å“ã€‚

### Q3: å¾®åº”ç”¨å¯ä»¥è¯»å–çŠ¶æ€å—ï¼Ÿ

**A**: å¯ä»¥ã€‚é€šè¿‡ `props.onGlobalStateChange` ç›‘å¬ï¼Œæˆ–è€…ä¸»åº”ç”¨ä¼ é€’ `getGlobalState` å‡½æ•°ã€‚

### Q4: ä¸ºä»€ä¹ˆå¾®åº”ç”¨ä¸èƒ½ä¿®æ”¹ `lang`ï¼Ÿ

**A**: å®‰å…¨è€ƒè™‘ã€‚`allowedFields` ä¸­åªåŒ…å« `breadcrumb`ï¼Œå…¶ä»–å­—æ®µä¼šè¢«è¿‡æ»¤æ‰ã€‚

---

å¸Œæœ›è¿™ä¸ªè§£é‡Šèƒ½å¸®ä½ ç†è§£ï¼å¦‚æœè¿˜æœ‰ç–‘é—®ï¼Œéšæ—¶é—®æˆ‘ ğŸ˜Š
